<!DOCTYPE html>
<html>
<head>
<title>Send Budget Recommendations</title>
<base target="_top">
<style>
/* Base styles - Copied from the original Email Sender */
body { font-family: sans-serif; font-size: 13px; margin: 0; padding: 15px; box-sizing: border-box; }
/* Headings and structure */
h3, h4 { margin-top: 0; margin-bottom: 15px; }
h3 { padding-top: 15px; border-top: 1px solid #ccc; font-weight: bold; }
h3:first-of-type { border-top: none; padding-top: 0; margin-top: 0; }
.form-group, #resultsView { margin-bottom: 15px; border: 1px solid #ccc; padding: 15px; border-radius: 5px; box-sizing: border-box; }
.optional-group { margin-top: 10px; }
/* Form element styling */
label { display: block; margin-bottom: 5px; font-weight: normal; cursor: default;}
label.inline-label { display: inline-block; margin-bottom: 0; vertical-align: middle; margin-left: 5px; font-weight: normal; cursor: pointer;}
label.required::after { content: "*"; color: red; margin-left: 5px; }
.form-group > label.required { font-weight: bold; }
/* Specific styling for bold label */
label.bold-label { font-weight: bold; }
select, input[type=text], input[type=email] {
    width: 100%; padding: 8px; margin-bottom: 15px; box-sizing: border-box;
    border: 1px solid black; border-radius: 4px; font-size: inherit;
    background-color: #fff; color: inherit;
}
select + .info-note, input + .info-note { margin-top: -10px; margin-bottom: 15px;}

input[type=checkbox] { margin-right: 5px; vertical-align: middle; cursor: pointer; }
/* Buttons */
button { padding: 10px 20px; font-size: 1em; border: 1px solid #aaa; border-radius: 4px; cursor: pointer; transition: background-color 0.1s ease, box-shadow 0.1s ease; background-color: #f0f0f0;}
button:hover { background-color: #e0e0e0; }
button:active { background-color: #d0d0d0; box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1); }
button:disabled { cursor: not-allowed; opacity: 0.6; background-color: #f0f0f0; box-shadow: none; }
.button-container { text-align: center; margin-top: 20px; }
.button-container button {
    display: block; width: fit-content; margin: 12px auto;
}
.result-actions button { display: inline-block; width: auto; margin: 10px 5px 0 5px; }

/* --- Inactive/Disabled States --- */
input:disabled, select:disabled, textarea:disabled {
  cursor: not-allowed; opacity: 0.7;
}
input[type=checkbox]:disabled { opacity: 0.6; }
input[type=checkbox]:disabled + label.inline-label { color: #999; font-weight: normal; cursor: default; }

/* Active/Inactive Toggles */
#enableBccSharedInbox:not(:checked) + label.inline-label,
#enableBccPop:not(:checked) + label.inline-label,
#enablePdfAttachment:not(:checked) + label.inline-label { 
  color: #999;
  font-weight: normal;
}
#enableBccSharedInbox:checked + label.inline-label,
#enableBccPop:checked + label.inline-label,
#enablePdfAttachment:checked + label.inline-label { 
  color: initial;
  font-weight: normal;
}

/* Placeholder Group Styles */
.placeholder-group.inactive { border-left-color: #ddd; }
.placeholder-group.inactive .placeholder-field label { color: #999; font-weight: normal; }
.placeholder-group:not(.inactive) .placeholder-field label { color: inherit; font-weight: bold; }

/* Specific layouts */
.info-note { 
    font-size: 0.9em; 
    color: #555; 
    padding: 8px 10px; 
    background-color: #f8f8f8; 
    border: 1px dashed #ccc; 
    border-radius: 4px;
    line-height: 1.4; 
}
.info-note.placeholder-note {
    margin-bottom: 15px;
}
.info-note code { background-color: #ddd; padding: 1px 3px; border-radius: 3px; font-family: monospace; }

/* NEW: Style from 03-2 for Date Range */
.lookback-group select { width: 100%; padding: 8px; margin-bottom: 0; }
.lookback-group { margin-bottom: 15px; }


/* NEW: Styles for File Drop Zone */
.drop-zone {
  border: 2px dashed #ccc;
  border-radius: 5px;
  padding: 25px;
  text-align: center;
  color: #777;
  cursor: pointer;
  position: relative;
  margin-bottom: 15px;
  transition: border-color 0.2s ease, background-color 0.2s ease;
}
.drop-zone.drag-over {
  border-color: #3498db;
  background-color: #f0f8ff;
}
.drop-zone input[type=file] {
  /* Hide the actual input but make it fill the space */
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 100%;
  opacity: 0;
  cursor: pointer;
}
#fileList {
  list-style: none;
  padding: 0;
  margin: 0;
  font-size: 0.9em;
}
#fileList li {
  padding: 5px 8px;
  background-color: #f9f9f9;
  border: 1px solid #eee;
  border-radius: 3px;
  margin-bottom: 5px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  word-break: break-all;
}
#fileList li span {
  padding-right: 10px;
}
#fileList li button {
  padding: 2px 8px;
  font-size: 1.1em;
  border: none;
  background-color: transparent;
  color: #999;
  cursor: pointer;
  line-height: 1;
}
#fileList li button:hover {
  color: #333;
}


/* Status/Results Area (retained) */
#statusMessage { margin-top: 15px; text-align: center; font-weight: bold; min-height: 1.2em; }
.status-error { color: red; }
.status-success { color: green; }
#resultsView h4 { margin-bottom: 10px; }
#errorList .report-category { font-weight: bold; margin-top: 8px; margin-bottom: 3px; font-size: 1.05em; }
.result-actions { text-align: center; margin-top: 20px; }
/* Loading State (retained) */
#loadingState { display: none; text-align: center; padding: 30px 15px; border: 1px solid #ccc; border-radius: 5px; background-color: #f9f9f9; }
.loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 15px auto; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

/* NEW: Warn-Hinweis Style (Das Einzige, was ich hinzugef?gt habe) */
#warning-banner {
    background-color: #fff3cd;
    color: #856404;
    padding: 10px;
    border-left: 4px solid #ffeeba;
    margin-bottom: 15px;
    font-size: 12px;
    display: none;
}
</style>
</head>
<body>

<div id="formContent">
  
  <div id="warning-banner">
     ?? <b>Do not close this sidebar!</b><br>
     Processing runs in batches. If you close this window, the process will stop.
  </div>

  <div class="form-group">
    <h3>Core settings</h3>
    <label for="executionCol" class="required">Trigger column</label>
    <select id="executionCol"></select>
    <p class="info-note">Select the column containing the trigger value '1'. Rows marked with '1' will be processed.</p>
    
    <label for="cidCol" class="required">Google Ads CID column</label>
    <select id="cidCol"></select>
    <p class="info-note">Select the column containing the client's 10-digit Google Ads ID (e.g., <code>123-456-7890</code>).</p>
    
    <label for="recipientCol" class="required">Recipient email column</label>
    <select id="recipientCol"></select>
    <p class="info-note">If a cell contains multiple emails, separate them with a semicolon (e.g., <code>abc@example.com; def@example.com</code>).</p>

    <label for="statusCol" class="required">Status column</label>
    <select id="statusCol"></select>
    <p class="info-note">
      To process many accounts (e.g., >20) without timing out, this script runs in batches. This column is used to track the status (e.g., "Draft Saved") for each row. Please select an empty column.
    </p>
    
    <label for="subjectLine" class="required">Subject line of Gmail draft</label>
    <input type="text" id="subjectLine" placeholder="Enter exact draft subject line">
    <p class="info-note">First, create an email draft in your Gmail 'Drafts' folder. Enter the <strong>exact subject line</strong> of that draft here. The script will use its body as the template.</p>

    <label for="ccCol" class="bold-label">Recipient email CC column</label>
    <select id="ccCol"><option value="" selected>None</option></select>
    <p class="info-note">Separate multiple emails with a semicolon.</p>

    <div style="display: flex; align-items: center; margin-bottom: 5px;">
        <input type="checkbox" id="enableBccSharedInbox" checked>
        <label for="enableBccSharedInbox" class="inline-label">BCC gcs-sharedinbox@google.com</label>
    </div>
     <div style="display: flex; align-items: center; margin-bottom: 15px;">
        <input type="checkbox" id="enableBccPop">
        <label for="enableBccPop" class="inline-label">BCC gcs-pop@google.com</label>
    </div>
  </div>

  <div class="form-group optional-group">
    <h3>Report Configuration</h3>
    <p class="info-note placeholder-note"> 
        Configure data generation options for the email content and attachments.
    </p>

    <div class="lookback-group">
      <label for="dateRange" class="required">Date Range</label>
      <select id="dateRange" required>
        <option value="" disabled selected>Select period</option>
        <option value="LAST_7_DAYS">Last 7 Days</option>
        <option value="LAST_14_DAYS">Last 14 Days</option>
        <option value="LAST_30_DAYS">Last 30 Days</option>
      </select>
    </div>
    
    <div id="pdfAttachmentGroup" style="margin-bottom: 15px;"> 
        <div style="display: flex; align-items: center;">
            <input type="checkbox" id="enablePdfAttachment">
            <label for="enablePdfAttachment" class="inline-label">Attach PDF Campaign Budget Report</label>
        </div>
    </div>
  </div>
  
  <div class="form-group optional-group">
    <h3>Placeholders</h3>
    <p class="info-note">Define placeholders like <code>{{ContactName}}</code> to personalize your email. Enter the tag below and select the corresponding column. Note: Dynamic data blocks for budget data will be inserted using specific placeholders in your draft (e.g., <code>[BUDGET_TABLE]</code>).</p>
    
    <div id="placeholder1Group" class="placeholder-group inactive">
        <div class="placeholder-activation">
            <input type="checkbox" id="activatePlaceholder1"><label for="activatePlaceholder1" class="inline-label">Activate Placeholder 1</label>
        </div>
        <div class="placeholder-controls">
            <div class="placeholder-field">
                <div><label for="placeholder1Col">Column</label><select id="placeholder1Col" disabled></select></div>
                <div><label for="placeholder1Name">Placeholder Tag</label><input type="text" id="placeholder1Name" placeholder="{{PlaceholderName}}" disabled></div>
            </div>
        </div>
    </div>
    <div id="placeholder2Group" class="placeholder-group inactive">
        <div class="placeholder-activation">
            <input type="checkbox" id="activatePlaceholder2" disabled><label for="activatePlaceholder2" class="inline-label">Activate Placeholder 2</label>
        </div>
        <div class="placeholder-controls">
            <div class="placeholder-field">
                <div><label for="placeholder2Col">Column</label><select id="placeholder2Col" disabled></select></div>
                <div><label for="placeholder2Name">Placeholder Tag</label><input type="text" id="placeholder2Name" placeholder="{{PlaceholderName}}" disabled></div>
            </div>
        </div>
    </div>
    <div id="placeholder3Group" class="placeholder-group inactive">
       <div class="placeholder-activation">
            <input type="checkbox" id="activatePlaceholder3" disabled><label for="activatePlaceholder3" class="inline-label">Activate Placeholder 3</label>
        </div>
        <div class="placeholder-controls">
            <div class="placeholder-field">
                <div><label for="placeholder3Col">Column</label><select id="placeholder3Col" disabled></select></div>
                <div><label for="placeholder3Name">Placeholder Tag</label><input type="text" id="placeholder3Name" placeholder="{{PlaceholderName}}" disabled></div>
            </div>
        </div>
    </div>
     <div id="placeholder4Group" class="placeholder-group inactive">
       <div class="placeholder-activation">
            <input type="checkbox" id="activatePlaceholder4" disabled><label for="activatePlaceholder4" class="inline-label">Activate Placeholder 4</label>
        </div>
        <div class="placeholder-controls">
            <div class="placeholder-field">
                <div><label for="placeholder4Col">Column</label><select id="placeholder4Col" disabled></select></div>
                <div><label for="placeholder4Name">Placeholder Tag</label><input type="text" id="placeholder4Name" placeholder="{{PlaceholderName}}" disabled></div>
            </div>
        </div>
    </div>
     <div id="placeholder5Group" class="placeholder-group inactive">
       <div class="placeholder-activation">
            <input type="checkbox" id="activatePlaceholder5" disabled><label for="activatePlaceholder5" class="inline-label">Activate Placeholder 5</label>
        </div>
        <div class="placeholder-controls">
            <div class="placeholder-field">
                <div><label for="placeholder5Col">Column</label><select id="placeholder5Col" disabled></select></div>
                <div><label for="placeholder5Name">Placeholder Tag</label><input type="text" id="placeholder5Name" placeholder="{{PlaceholderName}}" disabled></div>
            </div>
        </div>
    </div>
  </div>
  
  <div class="form-group optional-group">
    <h3>Attach File(s) to Email draft</h3>
    <p class="info-note">You can attach additional files (e.g., reports, images) to the email draft. Files are uploaded when you click "Start drafting".</p>
    
    <div id="dropZone" class="drop-zone">
      <input type="file" id="fileInput" multiple>
      <p id="dropZoneText">Drag & drop files here, or click to select</p>
    </div>
    <ul id="fileList"></ul> </div>
  
  <div class="button-container">
    <button id="draftButton" class="draft-button">Start drafting</button>
  </div>
  <div id="statusMessage"></div>
</div>

<div id="loadingState" style="display: none;">
  <p><strong id="loadingActionText">Processing...</strong><strong> Please wait.</strong></p>
  <div class="loader"></div>
  <p><small id="loadingSubText">This may take a few moments depending on the number of rows being processed.</small></p>
</div>

<div id="resultsView" style="display: none;">
    <h4 id="resultsTitle">Email process complete</h4>
    <p id="processedCountMessage"></p>
    <div id="errorReportSection">
        <div id="errorList"></div>
    </div>
    <div class="result-actions">
        <button id="runAgainButton">Configure new batch</button>
        <button id="closeButton">Close</button>
    </div>
</div>

<script>
  let currentResults = null;
  let attachedFiles = []; 
  // GLOBALE VARIABLES F?R POLLING
  let totalProcessed = 0;
  let retryCount = 0;
  const MAX_RETRIES = 3;

  // --- Helper Functions (Retained) ---
  const allColumnLetters = (() => { const letters = []; for (let i = 0; i < 26; i++) letters.push(String.fromCharCode(65 + i)); for (let i = 0; i < 26; i++) letters.push('A' + String.fromCharCode(65 + i)); for (let i = 0; i < 26; i++) letters.push('B' + String.fromCharCode(65 + i)); return letters; })();
  function populateDropdown(id, allowNone = false) {
      const select = document.getElementById(id); if (!select) return; select.innerHTML = ''; const d=document.createElement("option"); d.value=""; d.textContent=allowNone?"None":"Select column"; d.disabled=!allowNone; d.selected=true; select.appendChild(d); allColumnLetters.forEach(l => { const o=document.createElement("option"); o.value=l; o.textContent=l; select.appendChild(o); });
  }
  // --- End Helper Functions ---

  // --- Element References ---
  const formContent = document.getElementById('formContent'), loadingState = document.getElementById('loadingState'), loadingActionText = document.getElementById('loadingActionText'), resultsView = document.getElementById('resultsView'), resultsTitle = document.getElementById('resultsTitle'), 
      draftButton = document.getElementById('draftButton'), statusMessage = document.getElementById('statusMessage'), processedCountMessage = document.getElementById('processedCountMessage'), errorReportSection = document.getElementById('errorReportSection'), errorList = document.getElementById('errorList'), closeButton = document.getElementById('closeButton'), runAgainButton = document.getElementById('runAgainButton');
  
  const cidCol = document.getElementById('cidCol');
  const bccPopCheckbox = document.getElementById('enableBccPop');
  const enablePdfAttachmentCheckbox = document.getElementById('enablePdfAttachment');

  // NEU: statusCol Referenz
  const statusCol = document.getElementById('statusCol');

  const phCheckboxes = [1, 2, 3, 4, 5].map(i => document.getElementById(`activatePlaceholder${i}`));
  const phControls = [1, 2, 3, 4, 5].map(i => ({ group: document.getElementById(`placeholder${i}Group`), colSelect: document.getElementById(`placeholder${i}Col`), nameInput: document.getElementById(`placeholder${i}Name`) }));
  const bccSharedInboxCheckbox = document.getElementById('enableBccSharedInbox');

  // --- NEW: File Handling Functions (Unchanged) ---
  function handleFiles(files) {
    if (statusMessage) { statusMessage.textContent = ''; }
    for (const file of files) {
      if (attachedFiles.some(f => f.filename === file.name)) {
        if(statusMessage) { statusMessage.textContent = `File "${file.name}" is already added.`; statusMessage.className = 'status-error'; }
        continue;
      }
      const fileId = "file_" + Date.now() + "_" + Math.random();
      attachedFiles.push({ id: fileId, filename: file.name, mimeType: file.type || 'application/octet-stream', base64data: null });
      updateFileList();
      readFileAsBase64(file, fileId);
    }
  }
  function readFileAsBase64(file, fileId) {
    const reader = new FileReader();
    reader.onload = (e) => {
      const base64String = e.target.result.split(',')[1];
      const fileIndex = attachedFiles.findIndex(f => f.id === fileId);
      if (fileIndex > -1) { attachedFiles[fileIndex].base64data = base64String; }
      updateFileList();
    };
    reader.readAsDataURL(file);
  }
  function updateFileList() {
    const fileListEl = document.getElementById('fileList');
    if (!fileListEl) return;
    fileListEl.innerHTML = '';
    attachedFiles.forEach(file => {
      const li = document.createElement('li');
      const isLoading = file.base64data === null;
      li.innerHTML = `
        <span>${file.filename} ${isLoading ? '(Loading...)' : ''}</span>
        <button data-fileid="${file.id}">&times;</button>
      `;
      li.querySelector('button').addEventListener('click', (e) => {
        e.stopPropagation();
        removeFile(file.id);
      });
      fileListEl.appendChild(li);
    });
  }
  function removeFile(fileId) {
    attachedFiles = attachedFiles.filter(f => f.id !== fileId);
    updateFileList();
  }
  // --- End File Handling Functions ---


  /** Updates placeholder states (Retained) */
  function updatePlaceholderStates() {
    phCheckboxes.forEach((checkbox, index) => {
        if (!checkbox) return;
        const controls = phControls[index];
        if (!controls || !controls.group || !controls.colSelect || !controls.nameInput) return;

        const isPreviousChecked = (index === 0) || (phCheckboxes[index - 1] && phCheckboxes[index - 1].checked);
        checkbox.disabled = !isPreviousChecked;
        if (!isPreviousChecked) { checkbox.checked = false; }

        const isCurrentActive = checkbox.checked && !checkbox.disabled;
        populateDropdown(controls.colSelect.id, !isCurrentActive);
        controls.colSelect.disabled = !isCurrentActive;
        controls.nameInput.disabled = !isCurrentActive;
        controls.group.classList.toggle('inactive', !isCurrentActive);

        if (!isCurrentActive) {
            controls.nameInput.value = "";
            controls.colSelect.value = "";
        } else {
            if (!controls.colSelect.value) controls.colSelect.value = "";
        }
    });
  }

  /** Shows the main form view, hides others (UPDATED) */
  function showFormView() {
      if (statusMessage) { statusMessage.textContent = ''; statusMessage.className = ''; }
      if (resultsView) resultsView.style.display = 'none';
      if (loadingState) loadingState.style.display = 'none';
      if (formContent) formContent.style.display = 'block';
      if (draftButton) draftButton.disabled = false;
      document.getElementById('warning-banner').style.display = 'none'; // Hide warning
      currentResults = null;
      attachedFiles = [];
      updateFileList();
      totalProcessed = 0;
  }

  /** Handles button clicks (THIS IS THE CHANGED PART) */
  function handleButtonClick(actionType) {
    if(statusMessage) { statusMessage.textContent = ''; statusMessage.className = ''; }
    
    if (attachedFiles.some(f => f.base64data === null)) {
      if(statusMessage) {
        statusMessage.innerHTML = 'Error:<br>Files are still uploading. Please wait.';
        statusMessage.className = 'status-error';
      }
      return;
    }
    
    // GATHER ALL FORM DATA
    const formData = {
      executionCol: document.getElementById('executionCol').value,
      cidCol: cidCol.value, 
      recipientCol: document.getElementById('recipientCol').value,
      statusCol: statusCol.value,
      ccCol: document.getElementById('ccCol').value,
      subjectLine: document.getElementById('subjectLine').value.trim(),
      bccSharedInbox: bccSharedInboxCheckbox.checked,
      bccPop: bccPopCheckbox.checked, 
      dateRange: document.getElementById('dateRange').value,
      enablePdfAttachment: enablePdfAttachmentCheckbox.checked, 
      actionType: 'draft',
      placeholders: [],
      attachedFiles: attachedFiles.map(f => ({
        filename: f.filename,
        mimeType: f.mimeType,
        base64data: f.base64data
      }))
    };

    let errorMessages = [];
    const activePlaceholdersColumns = [];

    // Validation
    if (!formData.executionCol) { errorMessages.push('Select Trigger column.'); }
    if (!formData.cidCol) { errorMessages.push('Select Google Ads CID column.'); } 
    if (!formData.recipientCol) { errorMessages.push('Select Recipient email column.'); }
    if (!formData.statusCol) { errorMessages.push('Select a Status column.'); }
    if (!formData.subjectLine) { errorMessages.push('Enter Subject line (must match Gmail draft).'); }
    if (!formData.dateRange) { errorMessages.push('Select a Date Range.'); }

    // Placeholders validation
    phCheckboxes.forEach((checkbox, index) => {
        if (checkbox && checkbox.checked && !checkbox.disabled) {
            const num = index + 1;
            const controls = phControls[index];
            const colVal = controls.colSelect.value;
            const nameVal = controls.nameInput.value.trim();
            if (!colVal) errorMessages.push(`Placeholder ${num} is active, please select its Column.`);
            if (!nameVal) errorMessages.push(`Placeholder ${num} is active, please enter its Placeholder Tag.`);
            else if (!(nameVal.startsWith('{{') && nameVal.endsWith('}}') && nameVal.length > 4)) {
                errorMessages.push(`Placeholder ${num} Tag ('${nameVal}') must be in {{PlaceholderName}} format.`);
            }
            formData.placeholders.push({ col: colVal, name: nameVal });
            if (colVal) activePlaceholdersColumns.push(colVal);
        }
    });

    // Duplicate Check
    const columnsToCheck = [ 
        formData.executionCol, formData.cidCol, formData.recipientCol, formData.ccCol, formData.statusCol, ...activePlaceholdersColumns 
    ];
    const validSelectedColumns = columnsToCheck.filter(col => col && col !== "");
    if (new Set(validSelectedColumns).size < validSelectedColumns.length) {
        errorMessages.push('Duplicate column selection detected.');
    }

    if (errorMessages.length > 0) {
        if(statusMessage) { statusMessage.innerHTML = 'Error:<br>' + errorMessages.join('<br>'); statusMessage.className = 'status-error'; }
        return;
    }

    // Switch to loading view
    if(formContent) formContent.style.display = 'none';
    if(resultsView) resultsView.style.display = 'none';
    if(loadingState) loadingState.style.display = 'block';
    document.getElementById('warning-banner').style.display = 'block'; // Show "Don't Close" Warning
    
    if(loadingActionText) loadingActionText.textContent = 'Initializing process...'; 
    if (draftButton) draftButton.disabled = true;

    // *** START THE POLLING PROCESS (NEW) ***
    google.script.run
        .withSuccessHandler(function(res) {
             if(loadingActionText) loadingActionText.textContent = 'Processing Batch 1...'; 
             runBatchLoop(); // RECURSIVE START
        })
        .withFailureHandler(onFailure)
        .setupBudgetRun(formData); // Call Server V7.1 Setup
  }

  // --- THE ENGINE: RECURSIVE POLLING ---
  function runBatchLoop() {
      google.script.run
        .withSuccessHandler(function(result) {
            retryCount = 0; 

            // 1. FINISHED
            if (result.status === 'DONE') {
                onAllBatchesComplete();
                return;
            }

            // 2. CONTINUE
            if (result.status === 'CONTINUE') {
                totalProcessed += (result.processed || 0);
                if(loadingActionText) loadingActionText.textContent = `Processed ${totalProcessed} rows. Working on next batch...`;
                if(document.getElementById('loadingSubText') && result.remaining) {
                     document.getElementById('loadingSubText').textContent = `${result.remaining} rows remaining in queue...`;
                }
                
                // RECURSIVE CALL
                runBatchLoop(); 
            }

            // 3. BUSY
            if (result.status === 'BUSY') {
                console.log("Server busy, waiting...");
                setTimeout(runBatchLoop, 3000);
            }

            // 4. ERROR
            if (result.status === 'ERROR') {
                onFailure(new Error("Server Error: " + result.message));
            }
        })
        .withFailureHandler(function(err) {
             console.error(err);
             if (retryCount < MAX_RETRIES) {
                 retryCount++;
                 if(loadingActionText) loadingActionText.textContent = `Connection glitch. Retrying (${retryCount}/${MAX_RETRIES})...`;
                 setTimeout(runBatchLoop, 5000);
             } else {
                 onFailure(err);
             }
        })
        .processOneBatch(); // Calls Server V7.1 Worker
  }

  function onAllBatchesComplete() {
      if(loadingState) loadingState.style.display = 'none';
      document.getElementById('warning-banner').style.display = 'none';
      
      // Fill Results View
      resultsTitle.textContent = "All Batches Complete";
      processedCountMessage.textContent = `Successfully processed ${totalProcessed} rows in total.`;
      
      if(errorList) {
          errorList.innerHTML = '<p class="info-note">Check the <b>Status column</b> in your spreadsheet for details on each row (e.g. "Draft Saved" or error messages).</p>';
      }

      if(resultsView) resultsView.style.display = 'block';
  }

  function onFailure(error) { 
    console.error("onFailure received:", error);
    showFormView();
    if(statusMessage) { statusMessage.textContent = 'Script Error: ' + (error.message || 'Unknown error.'); statusMessage.className = 'status-error'; }
  }


  // --- Initial Setup (Retained) ---
  document.addEventListener('DOMContentLoaded', (event) => {
      try {
          // Populate dropdowns
          ['executionCol', 'cidCol', 'recipientCol', 'statusCol'].forEach(id => populateDropdown(id, false));
          populateDropdown('ccCol', true);
          [1, 2, 3, 4, 5].forEach(i => populateDropdown(`placeholder${i}Col`, true));

          // Listeners
          if (draftButton) draftButton.addEventListener('click', () => handleButtonClick('draft'));
          if (closeButton) closeButton.addEventListener('click', () => google.script.host.close());
          if (runAgainButton) runAgainButton.addEventListener('click', () => {
              showFormView();
          });
          phCheckboxes.forEach(checkbox => { if (checkbox) checkbox.addEventListener('change', updatePlaceholderStates); });
          
          // File Drop
          const dropZone = document.getElementById('dropZone');
          const fileInput = document.getElementById('fileInput');
          if (dropZone && fileInput) {
            dropZone.addEventListener('click', (e) => {
                if(e.target.id !== 'fileInput') { fileInput.click(); }
            });
            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
            dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('drag-over'); });
            dropZone.addEventListener('drop', (e) => {
              e.preventDefault();
              dropZone.classList.remove('drag-over');
              if (e.dataTransfer.files) { handleFiles(e.dataTransfer.files); }
            });
            fileInput.addEventListener('change', (e) => {
              if (e.target.files) { handleFiles(e.target.files); }
            });
          }
          
          updatePlaceholderStates();
          showFormView();
      } catch (initError) {
          console.error("Error during sidebar initialization:", initError);
      }
  });
</script>

</body>
</html>