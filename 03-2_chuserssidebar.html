<!DOCTYPE html>
<html>
<head>
<title>Find Change History Users</title>
<base target="_top">
<style>
/* Base styles */
body { font-family: sans-serif; font-size: 13px; margin: 0; padding: 15px; box-sizing: border-box; }
/* Headings and structure */
h3, h4 { margin-top: 0; margin-bottom: 15px; }
h3 { padding-top: 15px; border-top: 1px solid #ccc; font-weight: bold; }
h3:first-of-type { border-top: none; padding-top: 0; margin-top: 0; }
.form-group, #resultsView { margin-bottom: 15px; border: 1px solid #ccc; padding: 15px; border-radius: 5px; box-sizing: border-box; }
.optional-group { margin-top: 10px; }
/* Form element styling */
label { display: block; margin-bottom: 5px; font-weight: normal; cursor: default;}
label.inline-label { display: inline-block; margin-bottom: 0; vertical-align: middle; margin-left: 5px; font-weight: normal; cursor: pointer;} /* Used for checkboxes */
label.required::after { content: "*"; color: red; margin-left: 5px; }
.form-group > label.required, /* Targets direct children */
label[for="lookbackWindow"].required /* Specific rule for Lookback */
{ font-weight: bold; }
select, input[type=text] {
  width: 100%; padding: 8px; margin-bottom: 15px; box-sizing: border-box;
  border: 1px solid black; border-radius: 4px; font-size: inherit;
  background-color: #fff; color: inherit;
}
select + .info-note, input + .info-note { margin-top: -10px; margin-bottom: 15px;}

input[type=checkbox] { margin-right: 5px; vertical-align: middle; cursor: pointer; }
/* Buttons */
button { padding: 10px 20px; font-size: 1em; border: 1px solid #aaa; border-radius: 4px; cursor: pointer; transition: background-color 0.1s ease, box-shadow 0.1s ease; background-color: #f0f0f0;}
button:hover { background-color: #e0e0e0; }
button:active { background-color: #d0d0d0; box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1); }
button:disabled { cursor: not-allowed; opacity: 0.6; background-color: #f0f0f0; box-shadow: none; }
#runButton { /* Main action button */
  margin-left: auto; margin-right: auto; display: block;
  width: fit-content; margin-top: 20px; margin-bottom: 5px;
}
/* Centered, stacked results buttons */
.result-actions { margin-top: 20px; }
.result-actions button { display: block; width: fit-content; margin-left: auto; margin-right: auto; margin-top: 10px; margin-bottom: 5px; }

/* --- Inactive/Disabled States --- */
input:disabled, select:disabled, textarea:disabled { cursor: not-allowed; opacity: 0.7;}
input[type=checkbox]:disabled { opacity: 0.6; }
input[type=checkbox]:disabled + label.inline-label { color: #999; font-weight: normal; cursor: default; }
/* Hide dependent controls container when inactive */
.dependent-controls.inactive { display: none; }
/* Style disabled select directly */
select:disabled { background-color: #eee; border-color: #ddd; color: #999; }

/* Specific layouts */
.info-note { font-size: 0.9em; color: #555; padding: 8px 10px; background-color: #f8f8f8; border: 1px dashed #ccc; border-radius: 4px; margin-bottom: 15px;}
.user-column { margin-bottom: 15px; margin-top: 8px; } /* Added bottom margin */
.user-column > label.inline-label { vertical-align: middle; }
/* UPDATED: Style for dependent select container */
.dependent-controls {
  margin-top: 8px; /* Space above dropdown when visible */
  padding-left: 0; /* No indentation */
}
.dependent-controls select {
  width: 100%; padding: 8px; margin-bottom: 0; font-size: inherit; /* Standard padding */
}
.report-separate-global { margin-top: 15px; padding-left: 0; }
.report-separate-global > label.inline-label { vertical-align: middle; }
.lookback-group select { width: 100%; padding: 8px; margin-bottom: 0; }
.lookback-group { margin-bottom: 15px; }


/* Status/Results Area */
#statusMessage { margin-top: 10px; text-align: center; font-weight: bold; min-height: 1.2em; }
.status-error { color: red; }
.status-success { color: green; }
#resultsView h4 { margin-bottom: 10px; }
#errorReportSection { display: none; }
#errorList { max-height: 200px; overflow-y: auto; background-color: #f9f9f9; border: 1px solid #eee; padding: 10px; margin-top: 10px; font-size: 0.9em; }
#errorList ul { list-style: none; padding: 0; margin: 0; }
#errorList li { padding: 3px 0; border-bottom: 1px dotted #ddd; }
#errorList li:last-child { border-bottom: none; }
/* Report Categories */
#errorList .report-category { font-weight: bold; margin-top: 8px; margin-bottom: 3px; font-size: 1.05em; }
#errorList .report-category:first-child { margin-top: 0; }
#errorList .report-item { padding-left: 15px; }
#errorList .report-item.success { color: green; }
#errorList .report-item.not-found { color: orange; }
#errorList .report-item.error { color: red; }

/* Loading State */
#loadingState { display: none; text-align: center; padding: 30px 15px; border: 1px solid #ccc; border-radius: 5px; background-color: #f9f9f9; }
#loadingState p { margin-bottom: 15px; }
#loadingState small { color: #666; }
.loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 15px auto; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
</head>
<body>

<div id="formContent">
  <div class="form-group">
    <h3>Core settings</h3>

    <label for="triggerCol" class="required">Trigger column</label>
    <select id="triggerCol"></select>
    <p class="info-note">Select the column containing the trigger value '1'. Rows marked with '1' will be processed; other values or empty cells will be ignored.</p>

    <label for="cidCol" class="required">Internal CID column</label>
    <select id="cidCol"></select>

    <label for="lastUserCol" class="required">Output column for last user(s)</label>
    <select id="lastUserCol"></select>
    <p class="info-note">Select the column where the most recent user(s) found will be written.</p>

    <div class="lookback-group">
      <label for="lookbackWindow" class="required">Lookback window</label>
      <select id="lookbackWindow" required><option value="" disabled selected>Select period</option></select>
    </div>
  </div>

  <div class="form-group optional-group">
    <h3>Additional users</h3>
    <p class="info-note" style="margin-top: 0;">Optionally, find and output users prior to the last one found within the lookback window.</p>
    <div id="additionalUserColumns">
      <div class="user-column">
        <input type="checkbox" id="activateSecondLastUser">
        <label for="activateSecondLastUser" class="inline-label">Find 2nd last user</label>
        <div class="dependent-controls inactive"> <select id="secondLastUserCol" disabled></select>
        </div>
      </div>
      <div class="user-column">
        <input type="checkbox" id="activateThirdLastUser" disabled>
        <label for="activateThirdLastUser" class="inline-label">Find 3rd last user</label>
        <div class="dependent-controls inactive"> <select id="thirdLastUserCol" disabled></select>
        </div>
      </div>
      <div class="user-column">
        <input type="checkbox" id="activateFourthLastUser" disabled>
        <label for="activateFourthLastUser" class="inline-label">Find 4th last user</label>
        <div class="dependent-controls inactive"> <select id="fourthLastUserCol" disabled></select>
        </div>
      </div>
    </div>
    <div class="report-separate-global">
      <input type="checkbox" id="reportAdditionalUsersSeparately" disabled>
      <label for="reportAdditionalUsersSeparately" class="inline-label">Output in separate columns</label>
    </div>
    <p class="info-note" style="margin-top: 5px;">If checked, you must select a unique output column for each active 'additional user' above. If unchecked, all found users (last, 2nd last, etc.) are output into the 'Output column for last user(s)', separated by a semicolon and space.</p>
  </div>

  <button id="runButton">Start</button>
  <div id="statusMessage"></div>
</div>

<div id="loadingState" style="display: none;">
  <p><strong>Processing... Please wait.</strong></p>
  <div class="loader"></div>
  <p><small>This may take a few moments depending on the number of rows being processed.</small></p>
</div>

<div id="resultsView" style="display: none;">
    <h4>Processing complete</h4>
    <p id="processedCountMessage"></p>
    <div id="errorReportSection">
        <h4>Processing Report</h4>
        <div id="errorList"></div>
    </div>
    <div class="result-actions"> <button id="runAgainButton">Configure new batch</button>
        <button id="closeButton">Close</button>
    </div>
</div>

<script>
  // Store results globally for potential email sending
  let currentResults = null;

  /** Generates column letters A-BZ */
  const allColumnLetters = (() => { const letters = []; for (let i = 0; i < 26; i++) letters.push(String.fromCharCode(65 + i)); for (let i = 0; i < 26; i++) letters.push('A' + String.fromCharCode(65 + i)); for (let i = 0; i < 26; i++) letters.push('B' + String.fromCharCode(65 + i)); return letters; })();

  /** Populates a dropdown with column letters */
  function populateDropdown(id) { const select = document.getElementById(id); if (!select) return; select.innerHTML = ''; const defaultOption = document.createElement("option"); defaultOption.value = ""; defaultOption.textContent = "Select column"; defaultOption.disabled = true; defaultOption.selected = true; select.appendChild(defaultOption); allColumnLetters.forEach(letter => { const option = document.createElement("option"); option.value = letter; option.textContent = letter; select.appendChild(option); }); }

  /** Populates the lookback window dropdown */
  function populateLookbackDropdown() {
      const select = document.getElementById('lookbackWindow'); if (!select) return;
      for (let i = 1; i <= 30; i++) {
          const option = document.createElement("option"); option.value = i;
          option.textContent = (i === 1) ? "Today (1 day)" : i + " days";
          select.appendChild(option);
      }
  }

  // --- Element References ---
  // sendReportButton is removed from this list as the button itself is removed from HTML
  const formContent = document.getElementById('formContent'), loadingState = document.getElementById('loadingState'), resultsView = document.getElementById('resultsView'), runButton = document.getElementById('runButton'), statusMessage = document.getElementById('statusMessage'), processedCountMessage = document.getElementById('processedCountMessage'), errorReportSection = document.getElementById('errorReportSection'), errorList = document.getElementById('errorList'), closeButton = document.getElementById('closeButton'), runAgainButton = document.getElementById('runAgainButton');
  const reportCheckbox = document.getElementById('reportAdditionalUsersSeparately');
  const secondCheckbox = document.getElementById('activateSecondLastUser');
  const thirdCheckbox = document.getElementById('activateThirdLastUser');
  const fourthCheckbox = document.getElementById('activateFourthLastUser');
  const secondSelect = document.getElementById('secondLastUserCol');
  const thirdSelect = document.getElementById('thirdLastUserCol');
  const fourthSelect = document.getElementById('fourthLastUserCol');
  // Get references to the container divs for selects
  const secondControlsDiv = secondSelect ? secondSelect.parentElement : null;
  const thirdControlsDiv = thirdSelect ? thirdSelect.parentElement : null;
  const fourthControlsDiv = fourthSelect ? fourthSelect.parentElement : null;


  // --- State Update Functions ---

  /** CORRECTED: Updates dependent states for additional users/columns */
  function updateDropdownStates() {
      // Ensure all elements exist before proceeding
      if(!secondCheckbox || !reportCheckbox || !thirdCheckbox || !fourthCheckbox || !secondSelect || !thirdSelect || !fourthSelect || !secondControlsDiv || !thirdControlsDiv || !fourthControlsDiv) {
          console.error("One or more elements for dropdown state update not found.");
          return;
      }

      // Enable "Output in separate columns" checkbox only if "Find 2nd last user" is checked
      const canEnableReportCheckbox = secondCheckbox.checked;
      reportCheckbox.disabled = !canEnableReportCheckbox;
      if (reportCheckbox.disabled) reportCheckbox.checked = false; // Uncheck if disabled
      const separateOutput = reportCheckbox.checked;

      // Cascade enabling of 3rd/4th user checkboxes
      thirdCheckbox.disabled = !secondCheckbox.checked;
      if (thirdCheckbox.disabled) thirdCheckbox.checked = false;
      fourthCheckbox.disabled = !thirdCheckbox.checked;
      if (fourthCheckbox.disabled) fourthCheckbox.checked = false;

      // Enable/disable specific output column selects ONLY if separate output is checked
      const enableSecondSelect = secondCheckbox.checked && separateOutput;
      secondSelect.disabled = !enableSecondSelect;
      secondControlsDiv.classList.toggle('inactive', !enableSecondSelect); // Toggle container visibility/styling
      if (!enableSecondSelect) secondSelect.value = ""; // Reset if disabled

      const enableThirdSelect = thirdCheckbox.checked && separateOutput;
      thirdSelect.disabled = !enableThirdSelect;
      thirdControlsDiv.classList.toggle('inactive', !enableThirdSelect);
      if (!enableThirdSelect) thirdSelect.value = "";

      const enableFourthSelect = fourthCheckbox.checked && separateOutput;
      fourthSelect.disabled = !enableFourthSelect;
      fourthControlsDiv.classList.toggle('inactive', !enableFourthSelect);
      if (!enableFourthSelect) fourthSelect.value = "";
  }

  /** Shows the main form view, hides others */
  function showFormView() {
      if(statusMessage) { statusMessage.textContent = ''; statusMessage.className = ''; }
      if(resultsView) resultsView.style.display = 'none';
      if(loadingState) loadingState.style.display = 'none';
      if(formContent) formContent.style.display = 'block';
      if(runButton) runButton.disabled = false;
      currentResults = null;
      // The sendReportButton variable is no longer needed since the button is removed.
      // if (sendReportButton) sendReportButton.disabled = true;
  }

  /** Handles the 'Find users' button click */
  function handleButtonClick() {
    if(statusMessage) { statusMessage.textContent = ''; statusMessage.className = ''; }

    // Gather form data
    const formData = {
        cidCol: document.getElementById('cidCol').value,
        triggerCol: document.getElementById('triggerCol').value,
        lastUserCol: document.getElementById('lastUserCol').value,
        lookbackWindow: document.getElementById('lookbackWindow').value,
        activateSecondLastUser: secondCheckbox.checked,
        secondLastUserCol: secondSelect.value,
        activateThirdLastUser: thirdCheckbox.checked,
        thirdLastUserCol: thirdSelect.value,
        activateFourthLastUser: fourthCheckbox.checked,
        fourthLastUserCol: fourthSelect.value,
        reportAdditionalUsersSeparately: reportCheckbox.checked,
    };

    let errorMessages = [];

    // --- Validation ---
    if (!formData.cidCol) errorMessages.push('Select CID column.');
    if (!formData.triggerCol) errorMessages.push('Select Trigger column.');
    if (!formData.lastUserCol) errorMessages.push('Select Output column for last user(s).');
    if (!formData.lookbackWindow) errorMessages.push('Select Lookback window.');

    if (formData.reportAdditionalUsersSeparately) {
        if (formData.activateSecondLastUser && !formData.secondLastUserCol) errorMessages.push('Select column for 2nd last user (if separate output active).');
        if (formData.activateThirdLastUser && !formData.thirdLastUserCol) errorMessages.push('Select column for 3rd last user (if separate output active).');
        if (formData.activateFourthLastUser && !formData.fourthLastUserCol) errorMessages.push('Select column for 4th last user (if separate output active).');
    }

    // Check for Duplicate Column Selections
    const selectedColumns = [formData.cidCol, formData.triggerCol, formData.lastUserCol];
    if (formData.reportAdditionalUsersSeparately) {
        if (formData.activateSecondLastUser && formData.secondLastUserCol) selectedColumns.push(formData.secondLastUserCol);
        if (formData.activateThirdLastUser && formData.thirdLastUserCol) selectedColumns.push(formData.thirdLastUserCol);
        if (formData.activateFourthLastUser && formData.fourthLastUserCol) selectedColumns.push(formData.fourthLastUserCol);
    }
    const validSelectedColumns = selectedColumns.filter(col => col && col !== "");
    if (validSelectedColumns.length > 1) {
        if (new Set(validSelectedColumns).size < validSelectedColumns.length) {
            errorMessages.push('Duplicate column selection detected. Each selected column must be unique.');
        }
    }

    // --- Display Errors or Proceed ---
    if (errorMessages.length > 0) {
        if(statusMessage) {
            statusMessage.innerHTML = 'Error:<br>' + errorMessages.join('<br>');
            statusMessage.className = 'status-error';
        }
        return;
    }

    // --- If validation passes ---
    if(formContent) formContent.style.display = 'none';
    if(resultsView) resultsView.style.display = 'none';
    if(loadingState) loadingState.style.display = 'block';
    if(runButton) runButton.disabled = true;

    // Call Apps Script
    console.log("Calling processFormData with:", formData);
    google.script.run
        .withSuccessHandler(onSuccess)
        .withFailureHandler(onFailure)
        .processFormData(formData);
  }

  /**
   * Callback for SUCCESSFUL Apps Script execution.
   * Expects categorized results: { processedRowCount, succeeded:[], notFound:[], errorsLookup:[] }
   */
  function onSuccess(resultObject) {
    console.log("onSuccess received:", resultObject);
    if(loadingState) loadingState.style.display = 'none';

    if (!resultObject || typeof resultObject.processedRowCount === 'undefined' ||
        !Array.isArray(resultObject.succeeded) || !Array.isArray(resultObject.notFound) ||
        !Array.isArray(resultObject.errorsLookup)) {
        console.error("Invalid result object structure received from server:", resultObject);
        onFailure(new Error("Received invalid data structure from server.")); return;
    }

    currentResults = resultObject;

    if(processedCountMessage) processedCountMessage.textContent = `Attempted to process ${resultObject.processedRowCount} triggered row(s). See report below.`;

    // --- Build Categorized Report ---
    if(errorList) errorList.innerHTML = '';
    const ul = document.createElement('ul');
    let reportHasContent = false;

    const addReportItems = (category, items, cssClass) => {
        if (items.length > 0) {
            reportHasContent = true;
            const categoryHeader = document.createElement('div');
            categoryHeader.className = 'report-category';
            categoryHeader.textContent = `${category} (${items.length})`;
            ul.appendChild(categoryHeader);
            items.forEach(item => {
                const li = document.createElement('li');
                li.className = `report-item ${cssClass}`;
                li.textContent = `Row ${item.row || '?'}: ${item.details || 'Details N/A'}`;
                ul.appendChild(li);
            });
        }
    };

    addReportItems('Users Found', resultObject.succeeded, 'success');
    addReportItems('Users Not Found (in lookback)', resultObject.notFound, 'not-found');
    addReportItems('Errors During Lookup', resultObject.errorsLookup, 'error');

    if (reportHasContent) {
        errorList.appendChild(ul);
        if(errorReportSection) errorReportSection.style.display = 'block';
    } else {
        if (resultObject.processedRowCount === 0) {
            const li = document.createElement('li');
            li.textContent = "No rows marked with '1' found to process.";
            ul.appendChild(li);
            errorList.appendChild(ul);
            if(errorReportSection) errorReportSection.style.display = 'block';
        } else {
            if(errorReportSection) errorReportSection.style.display = 'none';
        }
    }
    // --- End Report Building ---

    if(resultsView) resultsView.style.display = 'block';
    // The sendReportButton is removed, so no need to enable/disable it here.
  }

  /** Callback for FAILED Apps Script execution (fatal errors). */
  function onFailure(error) {
    console.error("onFailure received:", error);
    showFormView();
    if(statusMessage) {
        statusMessage.textContent = 'Fatal Script Error: ' + (error.message || 'Unknown error occurred.');
        statusMessage.className = 'status-error';
    }
  }

  // The handleSendReport function is removed as the button is removed.
  // function handleSendReport() { /* ... */ }

  // --- Initial Setup & Event Listeners ---
  document.addEventListener('DOMContentLoaded', (event) => {
      try {
          // Populate dropdowns
          ['cidCol', 'triggerCol', 'lastUserCol', 'secondLastUserCol', 'thirdLastUserCol', 'fourthLastUserCol'].forEach(populateDropdown);
          populateLookbackDropdown();

          // Add Event Listeners
          if (secondCheckbox) secondCheckbox.addEventListener('change', updateDropdownStates);
          if (thirdCheckbox) thirdCheckbox.addEventListener('change', updateDropdownStates);
          if (fourthCheckbox) fourthCheckbox.addEventListener('change', updateDropdownStates);
          if (reportCheckbox) reportCheckbox.addEventListener('change', updateDropdownStates);
          if (closeButton) closeButton.addEventListener('click', () => google.script.host.close());
          if (runAgainButton) runAgainButton.addEventListener('click', showFormView);
          // The event listener for 'sendReportButton' is removed as the button is removed.
          if (runButton) {
              runButton.removeAttribute('onclick');
              runButton.addEventListener('click', handleButtonClick);
          }

          // Initial State
          updateDropdownStates();
          showFormView();
          console.log("Change History Sidebar UI Initialized");
      } catch (initError) {
          console.error("Error during sidebar initialization:", initError);
          document.body.innerHTML = `<p style="color:red; padding:15px;">Critical Error initializing sidebar: ${initError.message}. Please reload.</p>`;
      }
  });

</script>
</body>
</html>